<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RefOS: apps/console_server/src/device_input.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RefOS
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">Multi-server operating system on seL4</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('device__input_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">device_input.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Console Server input device implementation.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;<a class="el" href="stdio_8h_source.html">stdio.h</a>&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &lt;autoconf.h&gt;</code><br />
<code>#include &quot;<a class="el" href="device__input_8h_source.html">device_input.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="console__server_2src_2state_8h_source.html">state.h</a>&quot;</code><br />
<code>#include &lt;<a class="el" href="serv__connect_8h_source.html">refos-util/serv_connect.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="data__server_8h_source.html">refos-rpc/data_server.h</a>&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a280c226d161700513883a859bb505513"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#a280c226d161700513883a859bb505513">input_push_char</a> (struct <a class="el" href="structinput__state.html">input_state</a> *s, int c)</td></tr>
<tr class="memdesc:a280c226d161700513883a859bb505513"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a new character onto the getchar queue.  <a href="device__input_8c.html#a280c226d161700513883a859bb505513">More...</a><br /></td></tr>
<tr class="separator:a280c226d161700513883a859bb505513"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af34ab018d361f17b97664cbc8723e80f"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#af34ab018d361f17b97664cbc8723e80f">input_handle_irq</a> (void *cookie, uint32_t irq)</td></tr>
<tr class="memdesc:af34ab018d361f17b97664cbc8723e80f"><td class="mdescLeft">&#160;</td><td class="mdescRight">The IRQ handling callback function.  <a href="device__input_8c.html#af34ab018d361f17b97664cbc8723e80f">More...</a><br /></td></tr>
<tr class="separator:af34ab018d361f17b97664cbc8723e80f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af87f586e1b53a128b6ea9bbc54841525"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#af87f586e1b53a128b6ea9bbc54841525">input_init</a> (struct <a class="el" href="structinput__state.html">input_state</a> *s)</td></tr>
<tr class="memdesc:af87f586e1b53a128b6ea9bbc54841525"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialise input state manager and waiter list.  <a href="device__input_8c.html#af87f586e1b53a128b6ea9bbc54841525">More...</a><br /></td></tr>
<tr class="separator:af87f586e1b53a128b6ea9bbc54841525"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0225c858c0c1a6bc53a401516b32e37e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#a0225c858c0c1a6bc53a401516b32e37e">input_read</a> (struct <a class="el" href="structinput__state.html">input_state</a> *s, int *dest, uint32_t count)</td></tr>
<tr class="memdesc:a0225c858c0c1a6bc53a401516b32e37e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read from the input device backlog.  <a href="device__input_8c.html#a0225c858c0c1a6bc53a401516b32e37e">More...</a><br /></td></tr>
<tr class="separator:a0225c858c0c1a6bc53a401516b32e37e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab1da66511368997e22f1a9baae6e5824"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#ab1da66511368997e22f1a9baae6e5824">input_save_caller_as_waiter</a> (struct <a class="el" href="structinput__state.html">input_state</a> *s, struct <a class="el" href="structsrv__client.html">srv_client</a> *c, bool type)</td></tr>
<tr class="memdesc:ab1da66511368997e22f1a9baae6e5824"><td class="mdescLeft">&#160;</td><td class="mdescRight">Block current calling client and save its reply cap for when there is input available.  <a href="device__input_8c.html#ab1da66511368997e22f1a9baae6e5824">More...</a><br /></td></tr>
<tr class="separator:ab1da66511368997e22f1a9baae6e5824"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4750dac0c6b45ccb81288e636c3250e0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="device__input_8c.html#a4750dac0c6b45ccb81288e636c3250e0">input_purge_client</a> (struct <a class="el" href="structsrv__client.html">srv_client</a> *client)</td></tr>
<tr class="memdesc:a4750dac0c6b45ccb81288e636c3250e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Purge all weak references to client form waiting list. Used when client dies.  <a href="device__input_8c.html#a4750dac0c6b45ccb81288e636c3250e0">More...</a><br /></td></tr>
<tr class="separator:a4750dac0c6b45ccb81288e636c3250e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Console Server input device implementation. </p>
<p>Most of the actual input drivers work is fortunately done by the libplatsupport library. This module simply provides a client waiting list layer on top of getchar, managing client getc() and <a class="el" href="wceconf_8h.html#aac1b5ad836febcfd883ead1dd92e40bf">read()</a> syscalls into stdin.</p>
<p>When a character is typed but there is no one to listen, it goes into the backlog, buffered for the next <a class="el" href="wceconf_8h.html#aac1b5ad836febcfd883ead1dd92e40bf">read()</a> or getc() call. If the backlog is full, the oldest character is lost.</p>
<p>When a client wants to getc() with blocking enabled and there isn't a character already waiting to be recieved, the Console server must block the calling client until an RX irq comes in from the input device. This is implemented using seL4_SaveCaller functionality, saving the reply endpoint capability into a 'waiting list'. Whenever we recieve an IRQ, we go through this waiting list and reply to any waiters, unblocking their syscall. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="af34ab018d361f17b97664cbc8723e80f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af34ab018d361f17b97664cbc8723e80f">&#9670;&nbsp;</a></span>input_handle_irq()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void input_handle_irq </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>cookie</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>irq</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The IRQ handling callback function. </p>
<p>This callback function gets called from the interrupt dispatcher module to handle RX irqs. It adds the inputted character to the backlog, and then goes through the waiting list and replies to any waiters.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cookie</td><td>The input state structure (struct input_state*) </td></tr>
    <tr><td class="paramname">irq</td><td>The IRQ number. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="af87f586e1b53a128b6ea9bbc54841525"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af87f586e1b53a128b6ea9bbc54841525">&#9670;&nbsp;</a></span>input_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void input_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structinput__state.html">input_state</a> *&#160;</td>
          <td class="paramname"><em>s</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialise input state manager and waiter list. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">s</td><td>The input state structure. (No ownership transfer) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a4750dac0c6b45ccb81288e636c3250e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4750dac0c6b45ccb81288e636c3250e0">&#9670;&nbsp;</a></span>input_purge_client()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void input_purge_client </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structsrv__client.html">srv_client</a> *&#160;</td>
          <td class="paramname"><em>client</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Purge all weak references to client form waiting list. Used when client dies. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">client</td><td>The dying client to be purged. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a280c226d161700513883a859bb505513"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a280c226d161700513883a859bb505513">&#9670;&nbsp;</a></span>input_push_char()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void input_push_char </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structinput__state.html">input_state</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>c</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add a new character onto the getchar queue. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">s</td><td>The input state structure (struct input_state*) </td></tr>
    <tr><td class="paramname">c</td><td>The new character to push. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a0225c858c0c1a6bc53a401516b32e37e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0225c858c0c1a6bc53a401516b32e37e">&#9670;&nbsp;</a></span>input_read()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int input_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structinput__state.html">input_state</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>count</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read from the input device backlog. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">s</td><td>The input state structure. (No ownership transfer) </td></tr>
    <tr><td class="paramname">dest</td><td>Output buffer which the inputted chars will be written to. (No ownership transfer) </td></tr>
    <tr><td class="paramname">count</td><td>Maximum output buffer length in bytes. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Number of characters read successfully. 0 means no characters to be read, and if this is a blocking syscall, need to use <a class="el" href="device__input_8h.html#ab1da66511368997e22f1a9baae6e5824" title="Block current calling client and save its reply cap for when there is input available.">input_save_caller_as_waiter()</a> to block the calling client. </dd></dl>

</div>
</div>
<a id="ab1da66511368997e22f1a9baae6e5824"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1da66511368997e22f1a9baae6e5824">&#9670;&nbsp;</a></span>input_save_caller_as_waiter()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int input_save_caller_as_waiter </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structinput__state.html">input_state</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structsrv__client.html">srv_client</a> *&#160;</td>
          <td class="paramname"><em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>type</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Block current calling client and save its reply cap for when there is input available. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">s</td><td>The input state structure. (No ownership transfer) </td></tr>
    <tr><td class="paramname">c</td><td>The client to be blocked. (No ownership transfer) </td></tr>
    <tr><td class="paramname">type</td><td>The syscall type. Currently must be INPUT_WAITERTYPE_GETC. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>ESUCCESS on success, refos_err_t otherwise. </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_9654b8d08f4bba4e84b362c5fd320bee.html">apps</a></li><li class="navelem"><a class="el" href="dir_52ca6691134020d7990716e855f9e6e4.html">console_server</a></li><li class="navelem"><a class="el" href="dir_9fc4745385e894d605070f1ace990cff.html">src</a></li><li class="navelem"><a class="el" href="device__input_8c.html">device_input.c</a></li>
    <li class="footer">Generated on Sat Jun 10 2023 17:16:00 for RefOS by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
