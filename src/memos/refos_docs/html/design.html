<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RefOS: Design Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RefOS
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">Multi-server operating system on seL4</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('design.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Design Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Dataspace"></a>
Dataspace</h1>
<p>The overall design of RefOS revolves around the abstraction of a dataspace and the interfaces needed to manage them.</p>
<p>A dataspace is a memory space and is represented by a stream of bytes. Dataspaces may represent entities such as: </p><ul>
<li>
A physical file on disk (e.g. unix /bin/sh)  </li>
<li>
A hardware device (e.g. unix /dev/hda1)  </li>
<li>
A bit of anonymous memory (e.g. physical RAM)  </li>
<li>
A stream of bytes (e.g. unix /dev/urandom)  </li>
</ul>
<div class="image">
<img src="dataspace_example.png" alt=""/>
<div class="caption">
Figure 1 - Example Dataspace Setup</div></div>
<p>Dataspace servers (dataservers) implement the dataspace protocol interface and provide a dataspace abstraction service to clients. For example, in Figure 1, a portion of dataspace A is mapped into a client's memory window (client's virtual memory). When the client reads this memory, the client effectively reads the content in dataspace A. Another aspect of this figure is that dataspace A could initialise dataspace B with dataspace A's contents.</p>
<h1><a class="anchor" id="Interfaces"></a>
Interfaces</h1>
<p>The two main interfaces in RefOS are the process server and the data server. In addition to these two interfaces, there are a number of less major (but still important) interfaces, such as the name server interface, that provide additional functionality.</p>
<h3>Process Server Interface</h3>
<p>The process server interface creates process abstractions. The process server interface provides methods for: </p><ul>
<li>
Starting, ending and managing processes and threads  </li>
<li>
Creating, deleting and managing memory windows  </li>
<li>
Handling and delegating kernel page faults  </li>
</ul>
<h3>Data Server Interface</h3>
<p>The main goal of the data server interface is to provide dataspace abstraction. The data server interface provides methods for: </p><ul>
<li>
Creating, deleting and managing dataspaces  </li>
<li>
Mapping dataspaces to memory windows and thus allowing access to the contents of dataspaces  </li>
<li>
Initialising dataspaces with the contents of other dataspaces  </li>
<li>
Establishing pager services to map memory frames for memory windows mapped to dataspaces  </li>
</ul>
<h1><a class="anchor" id="Startup"></a>
Startup</h1>
<div class="image">
<img src="startup.png" alt=""/>
<div class="caption">
Figure 2 - RefOS Boot Protocol</div></div>
<p>In the RefOS boot protocol, the process server is started and initialises itself. Once the process server is running, the process server uses its interal ELF loader to start the file server and then starts the selfloader.</p>
<div class="image">
<img src="elfload.png" alt=""/>
<div class="caption">
Figure 3 - ELF Loading</div></div>
<p>The selfloader is a process that the process server spawns, and it is used for starting user processes. The selfloader runs in the same address space as the process it is starting. The selfloader establishes a connection to the file server, reads the ELF executable headers and then creates memory windows mapped to the bytes of the file content served by the file server. The selfloader also sets up a memory window for the stack pointer. After performing these tasks, the selfloader jumps to the entry point of the executable which causes a page fault on the first instruction read.</p>
<h1><a class="anchor" id="page_faults"></a>
Page Faults</h1>
<div class="image">
<img src="fault.png" alt=""/>
<div class="caption">
Figure 4 - Page Fault Handling</div></div>
<p>When a page fault occurs in a client program, the process server receives a page fault notification from the kernel. Since the selfloader initialised the memory windows for the client, the window that the client faulted in is data mapped to one of the process server's own dataspaces (representing anonymous memory).</p>
<p>The process server then notifies the file server that a page fault occurred. Having received the notifiction, the file server registers the fault event, handles the fault event and replies via interprocess communication. The file server provides any data that the process server asked for in its notification such as the window capability, the window offset and the memory page address.</p>
<p>The process server then copies the contents of the memory page to its own RAM dataspace and replies to the faulting message with the contents of the memory page, which causes the client to resume execution.</p>
<h1><a class="anchor" id="Dispatcher"></a>
Dispatcher</h1>
<p>RefOS's servers use a dispatcher algorithm to handle messages that they receive.</p>
<div class="image">
<img src="dispatcher.png" alt=""/>
<div class="caption">
Figure 5 - Dispatcher Design Overview</div></div>
<p>The best way to illustrate the RefOS dispatcher algorithm is through an example. Say a server receives a message. The message is analysed by dispatcher 1. If dispatcher 1 determines that the message is the type of message that it handles, dispatcher 1 handles the message. Otherwise, dispatcher 1 passes the message onto dispatcher 2. If dispatcher 1 passes the message onto dispatcher 2, dispatcher 2 also analyses the message and determines whether the message is the type of message that it handles. Just like dispatcher 1, dispatcher 2 either handles the message or passes the message onto dispatcher 3. This algorithm is repeated until the final dispatcher if necessary. If a dispatcher determines that a message is the correct message type for it to handle, the dispatcher handles the message by calling the appropriate handler function depending on the message contents. Of course, if a dispatcher handles a message, the message is now processed and is not passed onto the next dispatcher. If the final dispatcher determines that the message is not the correct message type for it to handle, the server produces an error message.</p>
<p>Note that in implementation each server does not necessarily have exactly four dispactchers. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jun 10 2023 10:14:24 for RefOS by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
