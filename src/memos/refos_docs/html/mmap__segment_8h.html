<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RefOS: libs/librefossys/include/refos-io/mmap_segment.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RefOS
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">Multi-server operating system on seL4</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mmap__segment_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">mmap_segment.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>MMap implementation for RefOS userland.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;autoconf.h&gt;</code><br />
<code>#include &lt;sel4/sel4.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;<a class="el" href="cbpool_8h_source.html">data_struct/cbpool.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="refos_8h_source.html">refos/refos.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="vmlayout_8h_source.html">refos/vmlayout.h</a>&gt;</code><br />
</div>
<p><a href="mmap__segment_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrefos__io__mmap__segment__state.html">refos_io_mmap_segment_state</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a7a63609076248ac25b252e225c208d99"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#a7a63609076248ac25b252e225c208d99">PROCESS_MMAP_LIMIT_SIZE_NPAGES</a>&#160;&#160;&#160;(<a class="el" href="vmlayout_8h.html#a2207ec2bce48bad1e56237b779885577">PROCESS_MMAP_LIMIT_SIZE</a> / <a class="el" href="refos_8h.html#a0928ee9c4bf6581eab888ff5514a8af2">REFOS_PAGE_SIZE</a>)</td></tr>
<tr class="separator:a7a63609076248ac25b252e225c208d99"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a834d20480bb3b1763946eda51488fd9b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#a834d20480bb3b1763946eda51488fd9b">PROCESS_MMAP_SEGMENT_SIZE_NPAGES</a>&#160;&#160;&#160;(128UL)</td></tr>
<tr class="separator:a834d20480bb3b1763946eda51488fd9b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab4e2af19675bc61acc57d5bfe24b4af"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#aab4e2af19675bc61acc57d5bfe24b4af">PROCESS_MMAP_SEGMENTS</a>&#160;&#160;&#160;(<a class="el" href="mmap__segment_8h.html#a7a63609076248ac25b252e225c208d99">PROCESS_MMAP_LIMIT_SIZE_NPAGES</a> / <a class="el" href="mmap__segment_8h.html#a834d20480bb3b1763946eda51488fd9b">PROCESS_MMAP_SEGMENT_SIZE_NPAGES</a>)</td></tr>
<tr class="separator:aab4e2af19675bc61acc57d5bfe24b4af"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a8b9b69c3ea86e0c5c4955ed41f0aa23d"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structrefos__io__mmap__segment__state.html">refos_io_mmap_segment_state</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a></td></tr>
<tr class="separator:a8b9b69c3ea86e0c5c4955ed41f0aa23d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:adeecc1b66859aa86504e4818028a8e76"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#adeecc1b66859aa86504e4818028a8e76">refosio_mmap_init</a> (<a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *s)</td></tr>
<tr class="separator:adeecc1b66859aa86504e4818028a8e76"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a681973e327b01d14585b755958fc6e2f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#a681973e327b01d14585b755958fc6e2f">refosio_mmap_segment_fill</a> (<a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *s, uint32_t vaddrOffsetPage)</td></tr>
<tr class="separator:a681973e327b01d14585b755958fc6e2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a709242629f6c23894a9f3ccb122f79c2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#a709242629f6c23894a9f3ccb122f79c2">refosio_mmap_segment_release</a> (<a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *s, uint32_t vaddrOffsetPage)</td></tr>
<tr class="separator:a709242629f6c23894a9f3ccb122f79c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae9626f332e56bf47dd59dc37628ea705"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#ae9626f332e56bf47dd59dc37628ea705">refosio_mmap_anon</a> (<a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *s, int npages, uint32_t *vaddrDest)</td></tr>
<tr class="separator:ae9626f332e56bf47dd59dc37628ea705"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acf0ad640961a6d7f542d567352e00b83"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmap__segment_8h.html#acf0ad640961a6d7f542d567352e00b83">refosio_munmap_anon</a> (<a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *s, uint32_t vaddr, int npages)</td></tr>
<tr class="separator:acf0ad640961a6d7f542d567352e00b83"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>MMap implementation for RefOS userland. </p>
<p>Unfortunately, the POSIX MMap interface doesn't play very happily with RefOS dataspace and window segment abstraction. Some tradeoffs here must be made between speed, overhead and efficiency.</p>
<p>RefOS userland dynamic MMap works as follows: </p><pre class="fragment">      bitmap (1 bit per 4096 page) 
                ▼
 1 0 0 1 0 1 1 0 1 ... 1 1 1 1 1 1 1 1 0 0 0 0 0 0 . . .
 |_________________________________|_____________ . . .
 ◀―――――――――――― segment ――――――――――――▶ 
        (128 pages per segment)
</pre><p> Pages are tracked using a bitmap, and segments are allocated via a bitmap allocator. This forms a crude 2 level page table. When a segment is allocated, all the page bits contained at flipped to 1. When unmap occurs, all the page bits are flipped to zero, and any segments with their entire contents unmapped would be deleted.</p>
<p>Note that we do not book-keep the dataspace and window caps here. We reply on the get functions from process server to book keep them, to avoid the inefficient double book-keeping.</p>
<p>ref: <a href="http://gcc.gnu.org/onlinedocs/libstdc++/manual/bitmap_allocator.html">http://gcc.gnu.org/onlinedocs/libstdc++/manual/bitmap_allocator.html</a> <a href="http://en.wikipedia.org/wiki/Free_space_bitmap">http://en.wikipedia.org/wiki/Free_space_bitmap</a> </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a7a63609076248ac25b252e225c208d99"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7a63609076248ac25b252e225c208d99">&#9670;&nbsp;</a></span>PROCESS_MMAP_LIMIT_SIZE_NPAGES</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROCESS_MMAP_LIMIT_SIZE_NPAGES&#160;&#160;&#160;(<a class="el" href="vmlayout_8h.html#a2207ec2bce48bad1e56237b779885577">PROCESS_MMAP_LIMIT_SIZE</a> / <a class="el" href="refos_8h.html#a0928ee9c4bf6581eab888ff5514a8af2">REFOS_PAGE_SIZE</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a834d20480bb3b1763946eda51488fd9b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a834d20480bb3b1763946eda51488fd9b">&#9670;&nbsp;</a></span>PROCESS_MMAP_SEGMENT_SIZE_NPAGES</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROCESS_MMAP_SEGMENT_SIZE_NPAGES&#160;&#160;&#160;(128UL)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aab4e2af19675bc61acc57d5bfe24b4af"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aab4e2af19675bc61acc57d5bfe24b4af">&#9670;&nbsp;</a></span>PROCESS_MMAP_SEGMENTS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROCESS_MMAP_SEGMENTS&#160;&#160;&#160;(<a class="el" href="mmap__segment_8h.html#a7a63609076248ac25b252e225c208d99">PROCESS_MMAP_LIMIT_SIZE_NPAGES</a> / <a class="el" href="mmap__segment_8h.html#a834d20480bb3b1763946eda51488fd9b">PROCESS_MMAP_SEGMENT_SIZE_NPAGES</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="a8b9b69c3ea86e0c5c4955ed41f0aa23d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8b9b69c3ea86e0c5c4955ed41f0aa23d">&#9670;&nbsp;</a></span>refos_io_mmap_segment_state_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structrefos__io__mmap__segment__state.html">refos_io_mmap_segment_state</a> <a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ae9626f332e56bf47dd59dc37628ea705"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae9626f332e56bf47dd59dc37628ea705">&#9670;&nbsp;</a></span>refosio_mmap_anon()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int refosio_mmap_anon </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>npages</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t *&#160;</td>
          <td class="paramname"><em>vaddrDest</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="adeecc1b66859aa86504e4818028a8e76"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adeecc1b66859aa86504e4818028a8e76">&#9670;&nbsp;</a></span>refosio_mmap_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void refosio_mmap_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *&#160;</td>
          <td class="paramname"><em>s</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a681973e327b01d14585b755958fc6e2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a681973e327b01d14585b755958fc6e2f">&#9670;&nbsp;</a></span>refosio_mmap_segment_fill()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int refosio_mmap_segment_fill </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>vaddrOffsetPage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a709242629f6c23894a9f3ccb122f79c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a709242629f6c23894a9f3ccb122f79c2">&#9670;&nbsp;</a></span>refosio_mmap_segment_release()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int refosio_mmap_segment_release </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>vaddrOffsetPage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="acf0ad640961a6d7f542d567352e00b83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acf0ad640961a6d7f542d567352e00b83">&#9670;&nbsp;</a></span>refosio_munmap_anon()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int refosio_munmap_anon </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="mmap__segment_8h.html#a8b9b69c3ea86e0c5c4955ed41f0aa23d">refos_io_mmap_segment_state_t</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>vaddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>npages</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_6719ab1f1f7655efc2fa43f7eb574fd1.html">libs</a></li><li class="navelem"><a class="el" href="dir_fc8f8daa8be559af06a0efdbcc1c92f5.html">librefossys</a></li><li class="navelem"><a class="el" href="dir_27e3fdfd5609335b892027cbd4968f2f.html">include</a></li><li class="navelem"><a class="el" href="dir_f3c165f30a0f87f9f310cf6a5c51766a.html">refos-io</a></li><li class="navelem"><a class="el" href="mmap__segment_8h.html">mmap_segment.h</a></li>
    <li class="footer">Generated on Sat Jun 10 2023 17:16:02 for RefOS by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
